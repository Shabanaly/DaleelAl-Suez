<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>لوحة التحكم - دليل السويس</title>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="../js/config.js"></script>
    <link rel="stylesheet" href="css/admin.css"> <!-- New Single Source CSS -->
    
    <script src="utils/helpers.js"></script>
    <script src="services/supabase.js"></script>
    <script src="services/stats.service.js"></script>
    <script src="components/sidebar.js"></script>
    <script src="components/topbar.js"></script>
</head>
<body>
    <div class="app-layout">
        <div id="sidebar-container"></div>
        <main class="main-content">
            <div id="topbar-container"></div>
            <div class="page-content">
                
                <!-- Stats -->
                <div class="grid-4" id="stats-container" style="margin-bottom: 32px;">
                    <div class="card">جاري التحميل...</div>
                </div>

                <!-- Recent Activity -->
                <div class="card">
                    <div style="display:flex; justify-content:space-between; margin-bottom:16px;">
                        <h3>آخر النشاطات</h3>
                        <a href="pages/places.html" class="btn btn-outline" style="height:32px; font-size:12px;">إدارة الأماكن</a>
                    </div>
                    <table class="table" id="recent-table">
                        <thead>
                            <tr>
                                <th>المكان</th>
                                <th>القسم</th>
                                <th>التاريخ</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr><td colspan="3" style="text-align:center;">جاري التحميل...</td></tr>
                        </tbody>
                    </table>
                </div>

            </div>
        </main>
    </div>

    <script>
        document.getElementById('sidebar-container').innerHTML = Sidebar.render('home');
        document.getElementById('topbar-container').innerHTML = Topbar.render('نظرة عامة');
        lucide.createIcons();

        async function init() {
            try {
                const stats = await StatsService.getDashboardStats();
                renderStats(stats);
                const recent = await StatsService.getRecentActivity();
                renderRecent(recent);
            } catch (e) {
                console.error(e);
            }
        }

        function renderStats(s) {
            document.getElementById('stats-container').innerHTML = `
                <div class="stat-card">
                    <div class="stat-icon"><i data-lucide="map-pin"></i></div>
                    <div><span class="stat-lbl">إجمالي الأماكن</span><span class="stat-val">${s.totalPlaces}</span></div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon"><i data-lucide="list"></i></div>
                    <div><span class="stat-lbl">الأقسام</span><span class="stat-val">${s.mainCategories}</span></div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon"><i data-lucide="clock"></i></div>
                    <div><span class="stat-lbl">اليوم</span><span class="stat-val">${s.addedToday}</span></div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon"><i data-lucide="users"></i></div>
                    <div><span class="stat-lbl">المستخدمين</span><span class="stat-val">-</span></div>
                </div>
            `;
            lucide.createIcons();
        }

        function renderRecent(items) {
            const tbody = document.querySelector('#recent-table tbody');
            if(!items.length) {
                tbody.innerHTML = '<tr><td colspan="3" style="text-align:center">لا يوجد بيانات</td></tr>';
                return;
            }
            tbody.innerHTML = items.map(i => `
                <tr>
                    <td><strong>${i.name_ar}</strong></td>
                    <td><span class="badge">${i.main_cat_id}</span></td>
                    <td>${Utils.formatDate(i.created_at)}</td>
                </tr>
            `).join('');
        }

        init();
    </script>
</body>
</html>
