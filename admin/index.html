<!doctype html>
<html lang="ar" dir="rtl">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… - Ø¯Ù„ÙŠÙ„ Ø§Ù„Ø³ÙˆÙŠØ³</title>
    <script src="services/auth.service.js"></script>
    <script>
      AuthService.checkAuth();
    </script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="../js/config.js"></script>
    <link rel="stylesheet" href="css/admin.css" />
    <!-- New Single Source CSS -->

    <script src="utils/helpers.js"></script>
    <script src="services/supabase.js"></script>
    <script src="services/stats.service.js"></script>
    <script src="components/sidebar.js"></script>
    <script src="components/topbar.js"></script>
    <script src="utils/drawer.js"></script>
  </head>
  <body>
    <div class="app-layout">
      <div id="sidebar-container"></div>
      <main class="main-content">
        <div id="topbar-container"></div>
        <div class="page-content">
          <!-- Stats -->
          <div class="grid-4" id="stats-container" style="margin-bottom: 32px">
            <div class="card">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
          </div>

          <!-- Recent Activity -->
          <div class="card">
            <div
              style="
                display: flex;
                justify-content: space-between;
                margin-bottom: 16px;
              "
            >
              <h3>Ø¢Ø®Ø± Ø§Ù„Ù†Ø´Ø§Ø·Ø§Øª</h3>
              <a
                href="pages/places.html"
                class="btn btn-outline"
                style="height: 32px; font-size: 12px"
                >Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ù…Ø§ÙƒÙ†</a
              >
            </div>
            <table class="table" id="recent-table">
              <thead>
                <tr>
                  <th>Ø§Ù„Ù…ÙƒØ§Ù†</th>
                  <th>Ø§Ù„Ù‚Ø³Ù…</th>
                  <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td colspan="3" style="text-align: center">
                    Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </main>
    </div>

    <script>
      // ğŸŒŸ Ø§Ø³Ø­Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©
      const currentUser = AuthService.getUserData();

      console.log("ğŸ‘¤ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ:", currentUser);

      document.getElementById("sidebar-container").innerHTML =
        Sidebar.render("home");
      document.getElementById("topbar-container").innerHTML =
        Topbar.render("Ù†Ø¸Ø±Ø© Ø¹Ø§Ù…Ø©");
      lucide.createIcons();

      async function init() {
        try {
          // ğŸŒŸ Ø¹Ù†Ø¯ Ø§Ù„ØªÙ‡ÙŠØ¦Ø©ØŒ Ø­Ø¯Ù‘Ø« Ø¢Ø®Ø± Ù†Ø´Ø§Ø· Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…
          if (currentUser) {
            AuthService.updateActivity();
            console.log("ğŸ“Š ØªÙ… ØªØ­Ø¯ÙŠØ« ÙˆÙ‚Øª Ø§Ù„Ù†Ø´Ø§Ø· Ø§Ù„Ø£Ø®ÙŠØ±");
          }

          const stats = await StatsService.getDashboardStats();
          renderStats(stats);
          const recent = await StatsService.getRecentActivity();
          renderRecent(recent);
        } catch (e) {
          console.error(e);
        }
      }

      function renderStats(s) {
        document.getElementById("stats-container").innerHTML = `
                <div class="stat-card">
                    <div class="stat-icon"><i data-lucide="map-pin"></i></div>
                    <div><span class="stat-lbl">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£Ù…Ø§ÙƒÙ†</span><span class="stat-val">${s.totalPlaces}</span></div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon"><i data-lucide="list"></i></div>
                    <div><span class="stat-lbl">Ø§Ù„Ø£Ù‚Ø³Ø§Ù…</span><span class="stat-val">${s.mainCategories}</span></div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon"><i data-lucide="clock"></i></div>
                    <div><span class="stat-lbl">Ø§Ù„ÙŠÙˆÙ…</span><span class="stat-val">${s.addedToday}</span></div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon"><i data-lucide="users"></i></div>
                    <div><span class="stat-lbl">Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</span><span class="stat-val">${currentUser ? "ğŸ‘¤ " + currentUser.email : "-"}</span></div>
                </div>
            `;
        lucide.createIcons();
      }

      function renderRecent(items) {
        const tbody = document.querySelector("#recent-table tbody");
        if (!items.length) {
          tbody.innerHTML =
            '<tr><td colspan="3" style="text-align:center">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª</td></tr>';
          return;
        }
        tbody.innerHTML = items
          .map(
            (i) => `
                <tr>
                    <td><strong>${i.name_ar}</strong></td>
                    <td><span class="badge">${i.main_cat_id}</span></td>
                    <td>${Utils.formatDate(i.created_at)}</td>
                </tr>
            `,
          )
          .join("");
      }

      init();
    </script>
  </body>
</html>
