<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>الأماكن - دليل السويس</title>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="../../js/config.js"></script>
    <link rel="stylesheet" href="../css/admin.css">
    
    <script src="../utils/helpers.js"></script>
    <script src="../services/supabase.js"></script>
    <script src="../services/places.service.js"></script>
    <script src="../services/categories.service.js"></script>
    <script src="../services/upload.service.js"></script>
    <script src="../components/sidebar.js"></script>
    <script src="../components/topbar.js"></script>
</head>
<body>
    <div class="app-layout">
        <div id="sidebar-container"></div>
        <main class="main-content">
            <div id="topbar-container"></div>
            <div class="page-content">
                
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:24px;">
                    <h2 class="page-title">إدارة الأماكن</h2>
                    <a href="places-form.html" class="btn btn-primary"><i data-lucide="plus"></i> إضافة مكان</a>
                </div>

                <div class="card">
                    <div style="display:flex; gap:16px; margin-bottom:24px;">
                        <input type="text" class="input" id="search-input" placeholder="بحث...">
                        <select class="input" id="cat-filter" style="width:200px;">
                            <option value="">كل الأقسام</option>
                        </select>
                    </div>

                    <table class="table" id="places-table">
                        <thead>
                            <tr>
                                <th>الاسم</th>
                                <th>القسم</th>
                                <th>الفرعي</th>
                                <th>الحالة</th>
                                <th>التاريخ</th>
                                <th>خيارات</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr><td colspan="6" style="text-align:center">جاري التحميل...</td></tr>
                        </tbody>
                    </table>
                </div>

            </div>
        </main>
    </div>

    <!-- Modal Removed. Uses places-form.html now. -->

    <script>
        document.getElementById('sidebar-container').innerHTML = Sidebar.render('places');
        document.getElementById('topbar-container').innerHTML = Topbar.render('الأماكن');
        
        let allPlaces = [];

        function init() {
            const cats = CategoriesService.getAll();
            const catSelect = document.getElementById('cat-filter');
            
            cats.forEach(c => {
                catSelect.innerHTML += `<option value="${c.id}">${c.label}</option>`;
            });

            loadPlaces();
            lucide.createIcons();
        }

        async function loadPlaces() {
            const filter = {
                search: document.getElementById('search-input').value,
                category: document.getElementById('cat-filter').value
            };
            
            document.querySelector('#places-table tbody').innerHTML = '<tr><td colspan="6" style="text-align:center">جاري التحميل...</td></tr>';
            
            // Strict Separation Logic
            if (filter.category) {
                allPlaces = await PlacesService.getPlacesByMainCategory(filter.category);
            } else if (filter.search) {
                // If search, use the generic getAll which handles search
                allPlaces = await PlacesService.getAll(filter);
            } else {
                // Default to Latest
                allPlaces = await PlacesService.getLatestPlaces();
            }

            renderTable(allPlaces);
        }

        function renderTable(list) {
            const tbody = document.querySelector('#places-table tbody');
            if (!list.length) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align:center">لا توجد نتائج</td></tr>';
                return;
            }

            tbody.innerHTML = list.map(p => `
                <tr>
                    <td style="font-weight:600">${p.name_ar}</td>
                    <td>${p.main_cat_id || '-'}</td>
                    <td>${p.sub_cat_id || '-'}</td>
                    <td><span class="badge active">منشور</span></td>
                    <td>${Utils.formatDate(p.created_at)}</td>
                    <td>
                        <a href="places-form.html?id=${p.id}" class="btn btn-outline btn-icon"><i data-lucide="edit-3"></i></a>
                        <button class="btn btn-danger btn-icon" onclick="deletePlace('${p.id}')"><i data-lucide="trash-2"></i></button>
                    </td>
                </tr>
            `).join('');
            lucide.createIcons();
        }

        // Search Handlers
        document.getElementById('search-input').addEventListener('input', () => loadPlaces());
        document.getElementById('cat-filter').addEventListener('change', loadPlaces);

        window.deletePlace = async (id) => {
            if(!confirm('حذف؟')) return;
            await PlacesService.delete(id);
            loadPlaces();
        };

        init();
    </script>
</body>
</html>
