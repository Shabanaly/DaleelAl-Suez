<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø¥Ø¶Ø§ÙØ©/ØªØ¹Ø¯ÙŠÙ„ Ù…ÙƒØ§Ù† - Ø¯Ù„ÙŠÙ„ Ø§Ù„Ø³ÙˆÙŠØ³</title>
    <script src="../services/auth.service.js"></script>
    <script>AuthService.checkAuth();</script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="../../js/config.js"></script>
    <link rel="stylesheet" href="../css/admin.css">
    
    <script src="../services/supabase.js"></script>
    <script src="../services/places.service.js"></script>
    <script src="../services/categories.service.js"></script>
    <script src="../services/upload.service.js"></script>
    <script src="../components/sidebar.js"></script>
    <script src="../components/topbar.js"></script>
    <script src="../utils/drawer.js"></script>
</head>
<body>
    <div class="app-layout">
        <div id="sidebar-container"></div>
        <main class="main-content">
            <div id="topbar-container"></div>
            <div class="page-content">
                
                <div style="display:flex; align-items:center; gap:16px; margin-bottom:24px;">
                    <a href="places.html" class="btn btn-outline btn-icon"><i data-lucide="arrow-right"></i></a>
                    <h2 class="page-title" id="form-title">Ø¥Ø¶Ø§ÙØ© Ù…ÙƒØ§Ù† Ø¬Ø¯ÙŠØ¯</h2>
                </div>

                <div class="card" style="max-width: 800px; margin: 0 auto; border-top: 4px solid var(--primary);">
                    <form id="place-form">
                        <input type="hidden" id="p_id">
                        
                        <div class="grid-2">
                            <div class="form-group">
                                <label class="form-label">Ø§Ù„Ø§Ø³Ù… Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© *</label>
                                <input id="p_name_ar" class="form-control" required placeholder="Ù…Ø«Ø§Ù„: Ù…Ø·Ø¹Ù… Ø§Ù„Ù†ÙŠÙ„">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Name in English *</label>
                                <input id="p_name_en" class="form-control" required placeholder="e.g., Nile Restaurant">
                            </div>
                        </div>

                        <div class="grid-2">
                            <div class="form-group">
                                <label class="form-label">Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ *</label>
                                <select id="p_main_cat" class="form-control" required onchange="updateSubCats()"></select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Ø§Ù„Ù‚Ø³Ù… Ø§Ù„ÙØ±Ø¹ÙŠ *</label>
                                <select id="p_sub_cat" class="form-control" required></select>
                            </div>
                        </div>

                        <div class="grid-2">
                            <div class="form-group">
                                <label class="form-label">Ø§Ù„Ø¹Ù†ÙˆØ§Ù† (Ù†Øµ ÙŠØ¸Ù‡Ø± ÙÙŠ Ø§Ù„ÙƒØ§Ø±Øª)</label>
                                <input id="p_address" class="form-control" placeholder="Ù…Ø«Ø§Ù„: Ø´Ø§Ø±Ø¹ Ø§Ù„Ø¬Ù„Ø§Ø¡ØŒ Ø§Ù„Ø³ÙˆÙŠØ³">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Ø±Ø§Ø¨Ø· Ø®Ø±ÙŠØ·Ø© Ø¬ÙˆØ¬Ù„ (Google Maps Link)</label>
                                <input id="p_map_url" class="form-control" placeholder="Ø§Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø· Ù…Ù† Ø®Ø±Ø§Ø¦Ø· Ø¬ÙˆØ¬Ù„">
                            </div>
                        </div>

                        <div class="grid-3">
                            <div class="form-group">
                                <label class="form-label">Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ Ø§Ù„ØªÙˆØ§ØµÙ„</label>
                                <input id="p_phone" class="form-control" placeholder="Ù…Ø«Ø§Ù„: 01012345678">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Ø±Ù‚Ù… Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨</label>
                                <input id="p_whatsapp" class="form-control" placeholder="Ù…Ø«Ø§Ù„: 01012345678">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Ø³Ø§Ø¹Ø§Øª Ø§Ù„Ø¹Ù…Ù„</label>
                                <input id="p_hours" class="form-control" placeholder="Ù…Ø«Ø§Ù„: 10 Øµ - 11 Ù…">
                            </div>
                        </div>
                        
                        <div class="grid-2">
                            <div class="form-group">
                                <label class="form-label">Ø§Ù„ÙˆØµÙ (Ø¹Ø±Ø¨ÙŠ)</label>
                                <textarea id="p_desc_ar" class="form-control" placeholder="ÙˆØµÙ Ù…ÙˆØ¬Ø² Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©..."></textarea>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Description (English)</label>
                                <textarea id="p_desc_en" class="form-control" placeholder="Brief description in English..."></textarea>
                            </div>
                        </div>

                        <!-- Upload Section -->
                        <div class="grid-2">
                            <div class="form-group">
                                <label class="form-label">Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© Ù„Ù„Ù…ÙƒØ§Ù†</label>
                                <div style="border: 2px dashed var(--border); padding: 24px; border-radius: 16px; text-align: center; cursor: pointer; transition: all 0.3s; background: var(--bg-body);" 
                                     onclick="document.getElementById('p_file').click()"
                                     id="upload-area">
                                    <input type="file" id="p_file" hidden accept="image/*" onchange="handleFileUpload(this)">
                                    <i data-lucide="image-plus" style="width:32px; height:32px; color:var(--text-muted); margin-bottom:8px;"></i>
                                    <div id="upload-msg" style="color:var(--text-main); font-weight:600; font-size: 13px;">Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</div>
                                    <input type="hidden" id="p_image">
                                </div>
                                <img id="preview-img" src="" style="width:100%; height:150px; object-fit:cover; border-radius:12px; margin-top:12px; display:none; border: 1px solid var(--border);">
                            </div>

                            <div class="form-group">
                                <label class="form-label">ØµÙˆØ± Ø§Ù„Ù…Ø¹Ø±Ø¶ (Gallery)</label>
                                <div style="border: 2px dashed var(--border); padding: 24px; border-radius: 16px; text-align: center; cursor: pointer; transition: all 0.3s; background: var(--bg-body);" 
                                     onclick="document.getElementById('gallery_files').click()">
                                    <input type="file" id="gallery_files" hidden accept="image/*" multiple onchange="handleGalleryUpload(this)">
                                    <i data-lucide="images" style="width:32px; height:32px; color:var(--text-muted); margin-bottom:8px;"></i>
                                    <div id="gallery-msg" style="color:var(--text-main); font-weight:600; font-size: 13px;">Ø±ÙØ¹ ØµÙˆØ± Ù„Ù„ØªÙØ§ØµÙŠÙ„</div>
                                </div>
                                <div id="gallery-preview" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-top: 12px;">
                                    <!-- Gallery items here -->
                                </div>
                            </div>
                        </div>

                        <!-- Featured Toggle (Old) -->
                        <div class="form-group" style="background: var(--primary-light); padding:16px; border-radius:12px; border: 1px solid var(--primary-soft); margin-top: 24px; display: none;">
                            <label class="form-label" style="display:flex; align-items:center; gap:10px; cursor:pointer; color: var(--primary); font-weight:800;">
                                <input type="checkbox" id="p_featured" style="width:20px; height:20px;">
                                <span>ØªÙ…ÙŠØ² Ù‡Ø°Ø§ Ø§Ù„Ù…ÙƒØ§Ù† ÙÙŠ Ù‚Ø³Ù… "Ø§Ø³ØªÙƒØ´Ù Ù…Ø¯ÙŠÙ†ØªÙƒ"</span>
                            </label>
                        </div>

                        <!-- NEW: Advanced Section Controls Hub -->
                        <div style="background: var(--bg-body); border: 1px solid var(--border); padding: 24px; border-radius: 20px; margin-top: 24px;">
                            <h4 style="font-size: 14px; color: var(--primary); font-weight: 800; margin-bottom: 20px; display: flex; align-items: center; gap: 8px;">
                                <i data-lucide="layout"></i> ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø£Ù‚Ø³Ø§Ù… ÙÙŠ Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
                            </h4>
                            
                            <div class="grid-3" style="margin-bottom: 24px;">
                                <label style="display:flex; align-items:center; gap:10px; cursor:pointer;" class="form-label">
                                    <input type="checkbox" id="p_featured_new" style="width:18px; height:18px;">
                                    <span>Ø§Ø³ØªÙƒØ´Ù Ù…Ø¯ÙŠÙ†ØªÙƒ (Spotlight)</span>
                                </label>
                                <label style="display:flex; align-items:center; gap:10px; cursor:pointer;" class="form-label">
                                    <input type="checkbox" id="p_trending" style="width:18px; height:18px;">
                                    <span>Ø§Ù„Ø£ÙƒØ«Ø± Ø¨Ø­Ø«Ø§Ù‹ (Trending)</span>
                                </label>
                                <label style="display:flex; align-items:center; gap:10px; cursor:pointer;" class="form-label">
                                    <input type="checkbox" id="p_urgent" style="width:18px; height:18px;">
                                    <span>Ø®Ø¯Ù…Ø§Øª Ø¹Ø§Ø¬Ù„Ø© (Quick)</span>
                                </label>
                            </div>

                            <div style="border-top: 1px dashed var(--border); padding-top: 20px;">
                                <label style="display:flex; align-items:center; gap:10px; cursor:pointer; margin-bottom: 16px;" class="form-label">
                                    <input type="checkbox" id="p_has_offer" style="width:18px; height:18px;" onchange="toggleOfferFields()">
                                    <span style="color: #f59e0b; font-weight: 800;">ØªÙØ¹ÙŠÙ„ Ù‚Ø³Ù… Ø§Ù„Ø¹Ø±ÙˆØ¶ ÙˆØ§Ù„Ø®ØµÙˆÙ…Ø§Øª ğŸ”¥</span>
                                </label>
                                
                                <div id="offer-fields" style="display: none;" class="grid-2">
                                    <div class="form-group">
                                        <label class="form-label">ÙˆØµÙ Ø§Ù„Ø¹Ø±Ø¶ (Ø¹Ø±Ø¨ÙŠ)</label>
                                        <input id="p_offer_ar" class="form-control" placeholder="Ù…Ø«Ø§Ù„: Ø®ØµÙ… 50% Ù„ÙØªØ±Ø© Ù…Ø­Ø¯ÙˆØ¯Ø©">
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Offer Description (EN)</label>
                                        <input id="p_offer_en" class="form-control" placeholder="e.g., 50% OFF Limited Time">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="form-actions" style="border-top:1px solid var(--border); padding-top:24px; margin-top:40px;">
                            <button type="submit" class="btn btn-primary" id="save-btn">
                                <i data-lucide="save"></i> Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                            </button>
                            <a href="places.html" class="btn btn-secondary">Ø¥Ù„ØºØ§Ø¡</a>
                        </div>
                    </form>
                </div>

            </div>
        </main>
    </div>

    <script>
        document.getElementById('sidebar-container').innerHTML = Sidebar.render('places');
        document.getElementById('topbar-container').innerHTML = Topbar.render('Ø§Ù„Ø£Ù…Ø§ÙƒÙ†');
        lucide.createIcons();

        const params = new URLSearchParams(window.location.search);
        const editId = params.get('id');
        let galleryImages = [];

        async function init() {
            // Populate Categories
            const catSelect = document.getElementById('p_main_cat');
            catSelect.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ...</option>';
            
            try {
                const cats = await CategoriesService.getAll();
                cats.forEach(c => {
                    catSelect.innerHTML += `<option value="${c.id}">${c.label}</option>`;
                });

                if (editId) {
                    document.getElementById('form-title').innerText = 'ØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ù…ÙƒØ§Ù†';
                    await loadPlaceData(editId);
                }
            } catch (e) {
                console.error("Initialization Error", e);
            }
        }

        async function loadPlaceData(id) {
            try {
                const place = await PlacesService.getById(id);
                if (place) {
                    document.getElementById('p_id').value = place.id;
                    document.getElementById('p_name_ar').value = place.name_ar;
                    document.getElementById('p_name_en').value = place.name_en || '';
                    document.getElementById('p_main_cat').value = place.main_cat_id;
                    
                    // Update subcategories based on main category
                    await updateSubCats();
                    document.getElementById('p_sub_cat').value = place.sub_cat_id || '';
                    
                    document.getElementById('p_address').value = place.address || '';
                    document.getElementById('p_map_url').value = place.map_url || '';
                    document.getElementById('p_phone').value = place.phone || '';
                    document.getElementById('p_whatsapp').value = place.whatsapp || '';
                    document.getElementById('p_hours').value = place.working_hours || '';
                    document.getElementById('p_desc_ar').value = place.desc_ar || '';
                    document.getElementById('p_desc_en').value = place.desc_en || '';
                    
                    if (place.image_url) {
                        document.getElementById('p_image').value = place.image_url;
                        const preview = document.getElementById('preview-img');
                        preview.src = place.image_url;
                        preview.style.display = 'block';
                    }

                    if (place.images && Array.isArray(place.images)) {
                        galleryImages = place.images;
                        renderGallery();
                    }

                    // Section Toggles
                    document.getElementById('p_featured_new').checked = !!place.is_featured;
                    document.getElementById('p_trending').checked = !!place.is_trending;
                    document.getElementById('p_urgent').checked = !!place.is_urgent;
                    document.getElementById('p_has_offer').checked = !!place.has_offer;
                    document.getElementById('p_offer_ar').value = place.offer_text_ar || '';
                    document.getElementById('p_offer_en').value = place.offer_text_en || '';
                    
                    toggleOfferFields();
                }
            } catch (e) {
                console.error("Load Place Error", e);
                alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');
            }
        }

        async function updateSubCats() {
            const mainId = document.getElementById('p_main_cat').value;
            const subSelect = document.getElementById('p_sub_cat');
            
            subSelect.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„Ù‚Ø³Ù… Ø§Ù„ÙØ±Ø¹ÙŠ...</option>';
            
            if (!mainId) return;

            try {
                const subs = await CategoriesService.getSubs(mainId);
                subSelect.innerHTML += subs.map(s => `<option value="${s.id}">${s.label}</option>`).join('');
            } catch (e) {
                console.error("Sub Cats Load Error", e);
            }
        }

        async function handleFileUpload(input) {
            if (!input.files || !input.files[0]) return;
            
            const file = input.files[0];
            const msg = document.getElementById('upload-msg');
            msg.innerText = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø±ÙØ¹...';
            
            try {
                const url = await UploadService.uploadImage(file, 'places');
                document.getElementById('p_image').value = url;
                
                const preview = document.getElementById('preview-img');
                preview.src = url;
                preview.style.display = 'block';
                msg.innerText = 'ØªÙ… Ø§Ù„Ø±ÙØ¹ Ø¨Ù†Ø¬Ø§Ø­!';
            } catch (e) {
                console.error(e);
                msg.innerText = 'ÙØ´Ù„ Ø§Ù„Ø±ÙØ¹ØŒ Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰';
                alert('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø±ÙØ¹: ' + e.message);
            }
        }

        async function handleGalleryUpload(input) {
            if (!input.files || input.files.length === 0) return;
            
            const msg = document.getElementById('gallery-msg');
            const originalText = msg.innerText;
            msg.innerText = 'Ø¬Ø§Ø±ÙŠ Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±...';
            
            try {
                for (let file of input.files) {
                    const url = await UploadService.uploadImage(file, 'places/gallery');
                    galleryImages.push(url);
                }
                renderGallery();
                msg.innerText = 'ØªÙ… Ø±ÙØ¹ ' + input.files.length + ' ØµÙˆØ± Ø¨Ù†Ø¬Ø§Ø­!';
                setTimeout(() => msg.innerText = originalText, 3000);
            } catch (e) {
                console.error(e);
                msg.innerText = 'Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø±ÙØ¹';
                alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø±ÙØ¹ Ø¨Ø¹Ø¶ Ø§Ù„ØµÙˆØ±');
            }
        }

        function renderGallery() {
            const container = document.getElementById('gallery-preview');
            container.innerHTML = galleryImages.map((url, index) => `
                <div style="position: relative; aspect-ratio: 1; border-radius: 8px; overflow: hidden; border: 1px solid var(--border);">
                    <img src="${url}" style="width: 100%; height: 100%; object-fit: cover;">
                    <button type="button" onclick="removeGalleryImage(${index})" 
                            style="position: absolute; top: 4px; right: 4px; width: 24px; height: 24px; background: rgba(239, 68, 68, 0.8); color: white; border: none; border-radius: 4px; cursor: pointer; display: flex; align-items: center; justify-content: center;">
                        <i data-lucide="trash-2" style="width: 14px; height: 14px;"></i>
                    </button>
                </div>
            `).join('');
            lucide.createIcons();
        }

        function removeGalleryImage(index) {
            galleryImages.splice(index, 1);
            renderGallery();
        }

        document.getElementById('place-form').onsubmit = async (e) => {
            e.preventDefault();
            const btn = document.getElementById('save-btn');
            btn.disabled = true;
            btn.innerHTML = '<i data-lucide="loader" class="spin"></i> Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸...';
            lucide.createIcons();

            const data = {
                name_ar: document.getElementById('p_name_ar').value,
                name_en: document.getElementById('p_name_en').value,
                main_cat_id: document.getElementById('p_main_cat').value,
                sub_cat_id: document.getElementById('p_sub_cat').value || null,
                address: document.getElementById('p_address').value,
                map_url: document.getElementById('p_map_url').value,
                phone: document.getElementById('p_phone').value,
                whatsapp: document.getElementById('p_whatsapp').value,
                working_hours: document.getElementById('p_hours').value,
                desc_ar: document.getElementById('p_desc_ar').value,
                desc_en: document.getElementById('p_desc_en').value,
                image_url: document.getElementById('p_image').value,
                images: galleryImages, // Save gallery array
                is_featured: document.getElementById('p_featured_new').checked,
                is_trending: document.getElementById('p_trending').checked,
                is_urgent: document.getElementById('p_urgent').checked,
                has_offer: document.getElementById('p_has_offer').checked,
                offer_text_ar: document.getElementById('p_offer_ar').value,
                offer_text_en: document.getElementById('p_offer_en').value,
                is_active: true
            };

            try {
                if (editId) {
                    await PlacesService.update(editId, data);
                } else {
                    await PlacesService.create(data);
                }
                alert('âœ… ØªÙ… Ø§Ù„Ø­ÙØ¸ Ø¨Ù†Ø¬Ø§Ø­');
                window.location.href = 'places.html';
            } catch (error) {
                console.error(error);
                alert('âŒ Ø­Ø¯Ø« Ø®Ø·Ø£: ' + error.message);
                btn.disabled = false;
                btn.innerHTML = '<i data-lucide="save"></i> Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª';
                lucide.createIcons();
            }
        };

        function toggleOfferFields() {
            const hasOffer = document.getElementById('p_has_offer').checked;
            document.getElementById('offer-fields').style.display = hasOffer ? 'grid' : 'none';
        }

        init();
    </script>
</body>
</html>
