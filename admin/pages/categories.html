<!doctype html>
<html lang="ar" dir="rtl">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ù‚Ø³Ø§Ù… - Ø¯Ù„ÙŠÙ„ Ø§Ù„Ø³ÙˆÙŠØ³</title>
    <script src="../services/auth.service.js"></script>
    <script>
      AuthService.checkAuth();
    </script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="../../js/config.js"></script>
    <link rel="stylesheet" href="../css/admin.css" />

    <script src="../services/supabase.js"></script>
    <script src="../services/categories.service.js"></script>
    <script src="../components/sidebar.js"></script>
    <script src="../components/topbar.js"></script>
    <script src="../utils/drawer.js"></script>

    <style>
      /* Only theme-specific or overrides here */
      .category-card {
        border: 1px solid var(--border);
        border-radius: 16px;
        padding: 24px;
        background: var(--bg-card);
        transition: all 0.3s;
      }
      .category-card:hover {
        transform: translateY(-4px);
        box-shadow: var(--shadow-lg);
      }
      .category-icon-wrapper {
        width: 56px;
        height: 56px;
        background: linear-gradient(135deg, var(--primary), var(--secondary));
        border-radius: 14px;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-bottom: 16px;
        color: white;
      }
    </style>
  </head>
  <body>
    <div class="app-layout">
      <div id="sidebar-container"></div>
      <main class="main-content">
        <div id="topbar-container"></div>
        <div class="page-content">
          <div class="categories-header">
            <h1><i data-lucide="layers"></i> Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ù‚Ø³Ø§Ù…</h1>
            <button class="btn btn-header-action" onclick="openCategoryModal()">
              <i data-lucide="plus-circle"></i> <span>Ø¥Ø¶Ø§ÙØ© Ù‚Ø³Ù… Ø¬Ø¯ÙŠØ¯</span>
            </button>
          </div>
          <div id="categories-container" class="grid-3"></div>
        </div>
      </main>
    </div>

    <!-- Modal -->
    <div
      id="category-modal"
      class="modal-overlay"
      onclick="closeCategoryModal()"
    >
      <div class="modal-box" onclick="event.stopPropagation()">
        <div class="modal-header">
          <h2 class="modal-title" id="modal-title">Ù‚Ø³Ù… Ø¬Ø¯ÙŠØ¯</h2>
          <button class="modal-close" onclick="closeCategoryModal()">Ã—</button>
        </div>
        <form id="category-form" onsubmit="saveCategory(event)">
          <div class="form-group">
            <label class="form-label">Ø§Ù„Ù…Ø¹Ø±Ù (ID) *</label>
            <input
              type="text"
              id="cat-id"
              class="form-control"
              required
              placeholder="restaurants"
            />
          </div>
          <div class="form-group">
            <label class="form-label">Ø§Ù„Ø§Ø³Ù… Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© *</label>
            <input
              type="text"
              id="cat-name-ar"
              class="form-control"
              required
              placeholder="Ù…Ø·Ø§Ø¹Ù…"
            />
          </div>
          <div class="form-group">
            <label class="form-label">Ø§Ù„Ø§Ø³Ù… Ø¨Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©</label>
            <input
              type="text"
              id="cat-name-en"
              class="form-control"
              placeholder="Restaurants"
            />
          </div>
          <div class="form-group">
            <label class="form-label">Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø©</label>
            <input
              type="text"
              id="cat-icon"
              class="form-control"
              placeholder="utensils"
            />
            <small class="form-hint"
              >Lucide icons (utensils, coffee, car...)</small
            >
          </div>

          <!-- Subcategories Management -->
          <div
            id="subs-mgmt-section"
            style="
              display: none;
              border-top: 2px solid var(--border);
              padding-top: 24px;
              margin-top: 24px;
            "
          >
            <h3
              style="
                font-size: 18px;
                font-weight: 800;
                margin-bottom: 16px;
                color: var(--primary);
              "
            >
              Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ø§Ù„ÙØ±Ø¹ÙŠØ©
            </h3>

            <div
              id="modal-subs-list"
              style="display: grid; gap: 8px; margin-bottom: 20px"
            >
              <!-- Rendered by JS -->
            </div>

            <div
              style="
                background: var(--bg-body);
                padding: 16px;
                border-radius: 12px;
                border: 1px dashed var(--border);
              "
            >
              <div
                style="font-size: 13px; font-weight: 700; margin-bottom: 12px"
              >
                Ø¥Ø¶Ø§ÙØ© Ù‚Ø³Ù… ÙØ±Ø¹ÙŠ Ø¬Ø¯ÙŠØ¯:
              </div>
              <div style="display: grid; gap: 10px">
                <input
                  type="text"
                  id="new-sub-id"
                  class="form-control"
                  style="font-size: 13px; padding: 8px 12px"
                  placeholder="ID (mish-mash)"
                />
                <input
                  type="text"
                  id="new-sub-name"
                  class="form-control"
                  style="font-size: 13px; padding: 8px 12px"
                  placeholder="Ø§Ù„Ø§Ø³Ù… Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©"
                />
                <button
                  type="button"
                  class="btn btn-primary"
                  style="padding: 8px; font-size: 13px"
                  onclick="handleAddSub()"
                >
                  <i data-lucide="plus"></i> Ø¥Ø¶Ø§ÙØ© Ø§Ù„ÙØ±Ø¹ÙŠ
                </button>
              </div>
            </div>
          </div>

          <div class="form-actions" style="margin-top: 40px">
            <button type="submit" class="btn btn-primary">
              Ø­ÙØ¸ Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ
            </button>
            <button
              type="button"
              class="btn btn-secondary"
              onclick="closeCategoryModal()"
            >
              Ø¥Ù„ØºØ§Ø¡
            </button>
          </div>
        </form>
      </div>
    </div>

    <script>
      // ğŸ”’ State Management Ù…Ø­Ø³Ù‘Ù†
      let allCategories = [];
      let editingCategoryId = null;
      let isSaving = false;
      let loadingIndicator = 0;
      const requestTimeout = 15000; // 15 Ø«Ø§Ù†ÙŠØ©

      document.getElementById('sidebar-container').innerHTML = Sidebar.render('categories');
      document.getElementById('topbar-container').innerHTML = Topbar.render('Ø§Ù„Ø£Ù‚Ø³Ø§Ù…');

      async function init() {
          lucide.createIcons();
          await loadCategories();
      }

      // ğŸŒŸ Ø¯Ø§Ù„Ø© ØªØ­Ø¯ÙŠØ« Ù…Ø­Ù„ÙŠ
      function updateLocalCategory(catId, updatedData) {
          const categoryIndex = allCategories.findIndex(c => c.id === catId);
          if (categoryIndex !== -1) {
              allCategories[categoryIndex] = {
                  ...allCategories[categoryIndex],
                  ...updatedData
              };
              renderCategories(allCategories);
          }
      }

      // ğŸŒŸ Ø¯Ø§Ù„Ø© Ø¥Ø¶Ø§ÙØ© Ù…Ø­Ù„ÙŠØ©
      function addCategoryLocally(categoryData) {
          const newCategory = {
              ...categoryData,
              label: categoryData.name_ar,
              subs: categoryData.subs || []
          };
          allCategories.unshift(newCategory);
          renderCategories(allCategories);
      }

      async function loadCategories() {
          const container = document.getElementById('categories-container');

          // ğŸ”’ Ù…Ù†Ø¹ Ø§Ù„Ø§Ø³ØªØ¯Ø¹Ø§Ø¡Ø§Øª Ø§Ù„Ù…ØªÙƒØ±Ø±Ø©
          if (loadingIndicator > 0) {
              console.warn('â³ ØªØ­Ù…ÙŠÙ„ Ø¬Ø§Ø±ÙŠ Ø¨Ø§Ù„ÙØ¹Ù„...');
              return;
          }

          loadingIndicator++;
          container.innerHTML = '<div style="grid-column: 1/-1; text-align: center; padding: 60px;"><i data-lucide="loader" style="width: 48px; height: 48px; animation: spin 1s linear infinite;"></i></div>';

          try {
              // ğŸ”„ Ù…Ø¹ timeout
              const timeoutPromise = new Promise((_, reject) =>
                  setTimeout(() => reject(new Error('Ø§Ù†ØªÙ‡Øª Ù…Ù‡Ù„Ø© Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø·Ù„Ø¨ - ØªØ¬Ø§ÙˆØ² 15 Ø«Ø§Ù†ÙŠØ©')), requestTimeout)
              );

              const loadPromise = CategoriesService.getAll();
              allCategories = await Promise.race([loadPromise, timeoutPromise]);

              if (!allCategories.length) {
                  container.innerHTML = `
                      <div class="empty-state">
                          <i data-lucide="inbox"></i>
                          <h3>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ù‚Ø³Ø§Ù… Ø¨Ø¹Ø¯</h3>
                          <p>Ø§Ø¨Ø¯Ø£ Ø¨Ø¥Ø¶Ø§ÙØ© Ù‚Ø³Ù… Ø¬Ø¯ÙŠØ¯ Ù…Ù† Ø§Ù„Ø²Ø± Ø£Ø¹Ù„Ø§Ù‡</p>
                      </div>
                  `;
              } else {
                  renderCategories(allCategories);
                                  </button>
                                  <button class="btn btn-danger" style="flex: 1; padding: 8px;" onclick="deleteCategory('${cat.id}')">
                                      <i data-lucide="trash-2" style="width: 18px; height: 18px;"></i>
                                      Ø­Ø°Ù
                                  </button>
                              </div>
                          </div>
                      `;
                  }).join('');
              }
                lucide.createIcons();
            } catch (error) {
                console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„:', error);
                container.innerHTML = `
                    <div class="empty-state">
                        <i data-lucide="alert-circle" style="color: #dc2626;"></i>
                        <h3>Ø­Ø¯Ø« Ø®Ø·Ø£</h3>
                        <p>${error.message}</p>
                    </div>
                `;
                lucide.createIcons();
            } finally {
                loadingIndicator--;
            }
        }

        function renderCategories(categories) {
            const container = document.getElementById('categories-container');
            if (!container) return;

            if (!categories.length) {
                container.innerHTML = '<div class="empty-state"><i data-lucide="inbox"></i><h3>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ù‚Ø³Ø§Ù… Ø¨Ø¹Ø¯</h3></div>';
                return;
            }

            container.innerHTML = categories.map(cat => {
                const subs = cat.subs || [];
                return `
                    <div class="category-card">
                        <div class="category-icon-wrapper">
                            <i data-lucide="${cat.icon || 'folder'}"></i>
                        </div>
                        <h3 class="category-title">${cat.label}</h3>
                        <div class="category-id">${cat.id}</div>

                        <div class="subcategories-section">
                            <div class="subcategories-label">Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ø§Ù„ÙØ±Ø¹ÙŠØ© (${subs.length})</div>
                            <div class="subcategories-list">
                                ${subs.length ? subs.slice(0, 3).map(s => `<span class="sub-badge">${s.label}</span>`).join('') : '<span style="color: var(--text-muted); font-size: 13px;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ù‚Ø³Ø§Ù… ÙØ±Ø¹ÙŠØ©</span>'}
                                ${subs.length > 3 ? `<span class="sub-badge">+${subs.length - 3}</span>` : ''}
                            </div>
                        </div>

                        <div class="category-actions">
                            <button class="btn btn-outline" style="flex: 1; padding: 8px;" onclick="editCategory('${cat.id}')">
                                <i data-lucide="edit-2" style="width: 18px; height: 18px;"></i>
                                ØªØ¹Ø¯ÙŠÙ„
                            </button>
                            <button class="btn btn-danger" style="flex: 1; padding: 8px;" onclick="deleteCategory('${cat.id}')">
                                <i data-lucide="trash-2" style="width: 18px; height: 18px;"></i>
                                Ø­Ø°Ù
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
            lucide.createIcons();
        }

        function openCategoryModal(catId = null) {
            editingCategoryId = catId;
            const modal = document.getElementById('category-modal');
            const form = document.getElementById('category-form');
            const title = document.getElementById('modal-title');
            const subsSection = document.getElementById('subs-mgmt-section');

          form.reset();

          if (catId) {
              title.innerText = 'ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù‚Ø³Ù…';
              loadCategoryData(catId);
              document.getElementById('cat-id').disabled = true;
              subsSection.style.display = 'block';
          } else {
              title.innerText = 'Ù‚Ø³Ù… Ø¬Ø¯ÙŠØ¯';
              document.getElementById('cat-id').disabled = false;
              subsSection.style.display = 'none';
          }

          modal.classList.add('active');
      }

      async function loadCategoryData(catId) {
          // ğŸŒŸ Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ© Ø¨Ø¯Ù„Ù‹Ø§ Ù…Ù† Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ API
          let cat = allCategories.find(c => c.id === catId);

          // Ø¥Ø°Ø§ Ù„Ù… ØªÙˆØ¬Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­Ù„ÙŠÙ‹Ø§ØŒ Ø§Ø³ØªØ¯Ø¹Ù API (Ø­Ø§Ù„Ø© Ù†Ø§Ø¯Ø±Ø©)
          if (!cat) {
              console.warn('ğŸ“¡ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©ØŒ Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ API...');
              const cats = await CategoriesService.getAll();
              cat = cats.find(c => c.id === catId);
          }

          if (cat) {
              document.getElementById('cat-id').value = cat.id;
              document.getElementById('cat-name-ar').value = cat.name_ar;
              document.getElementById('cat-name-en').value = cat.name_en || '';
              document.getElementById('cat-icon').value = cat.icon || '';
              renderSubsList(cat.subs || []);
          }
      }

      function renderSubsList(subs) {
          const container = document.getElementById('modal-subs-list');
          if (subs.length === 0) {
              container.innerHTML = '<div style="color: var(--text-muted); font-size: 13px; text-align: center; padding: 10px;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ù‚Ø³Ø§Ù… ÙØ±Ø¹ÙŠØ© Ø¨Ø¹Ø¯</div>';
              return;
          }

          container.innerHTML = subs.map(sub => `
              <div style="display: flex; justify-content: space-between; align-items: center; background: var(--bg-body); padding: 8px 12px; border-radius: 8px; border: 1px solid var(--border);">
                  <div>
                      <span style="font-weight: 700; font-size: 14px;">${sub.name_ar}</span>
                      <code style="font-size: 11px; color: var(--text-muted); margin-right: 8px;">(${sub.id})</code>
                  </div>
                  <button type="button" class="btn btn-danger btn-icon" style="width: 32px; height: 32px;" onclick="handleDeleteSub('${sub.id}')">
                      <i data-lucide="x" style="width: 14px; height: 14px;"></i>
                  </button>
              </div>
          `).join('');
          lucide.createIcons();
      }

      async function handleAddSub() {
          const idInput = document.getElementById('new-sub-id');
          const nameInput = document.getElementById('new-sub-name');
          const addBtn = document.querySelector('#subs-mgmt-section button[onclick="handleAddSub()"]');

          const id = idInput.value.trim();
          const name = nameInput.value.trim();

          if (!id || !name) {
              alert('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ù…Ø¹Ø±Ù ÙˆØ§Ù„Ø§Ø³Ù…');
              return;
          }

          try {
              // ğŸ”’ ØªØ¹Ø·ÙŠÙ„ Ø§Ù„Ø²Ø±
              if (addBtn) {
                  addBtn.disabled = true;
                  addBtn.innerHTML = '<i data-lucide="loader" style="width: 14px; height: 14px; animation: spin 1s linear infinite;"></i> Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥Ø¶Ø§ÙØ©...';
                  lucide.createIcons();
              }

              // ğŸŒŸ Ø¥Ø¶Ø§ÙØ© Ù…Ø­Ù„ÙŠØ© ÙÙˆØ±ÙŠØ©
              const category = allCategories.find(c => c.id === editingCategoryId);
              if (category) {
                  const newSub = {
                      id,
                      name_ar: name,
                      main_cat_id: editingCategoryId,
                      label: name
                  };
                  if (!category.subs) category.subs = [];
                  category.subs.unshift(newSub);
                  renderSubsList(category.subs);
              }

              // Ø«Ù… Ø¥Ø±Ø³Ø§Ù„ Ù„Ù„Ù€ API
              await CategoriesService.createSub({
                  id,
                  name_ar: name,
                  main_cat_id: editingCategoryId
              });

              // Clear inputs
              idInput.value = '';
              nameInput.value = '';

              console.log('âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù‚Ø³Ù… Ø§Ù„ÙØ±Ø¹ÙŠ Ø¨Ù†Ø¬Ø§Ø­');
          } catch (error) {
              console.error(error);
              // Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø¹Ù†Ø¯ Ø§Ù„Ø®Ø·Ø£ ÙÙ‚Ø·
              await loadCategoryData(editingCategoryId);
              alert('âŒ Ø®Ø·Ø£ ÙÙŠ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù‚Ø³Ù… Ø§Ù„ÙØ±Ø¹ÙŠ: ' + error.message);
          } finally {
              // ğŸ”’ Ø¥Ø¹Ø§Ø¯Ø© ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø²Ø±
              if (addBtn) {
                  addBtn.disabled = false;
                  addBtn.innerHTML = '<i data-lucide="plus"></i> Ø¥Ø¶Ø§ÙØ© Ø§Ù„ÙØ±Ø¹ÙŠ';
                  lucide.createIcons();
              }
          }
      }

      async function handleDeleteSub(subId) {
          if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù‚Ø³Ù… Ø§Ù„ÙØ±Ø¹ÙŠØŸ')) return;

          try {
              // ğŸŒŸ Ø­Ø°Ù Ù…Ø­Ù„ÙŠ ÙÙˆØ±ÙŠ
              const category = allCategories.find(c => c.id === editingCategoryId);
              if (category && category.subs) {
                  category.subs = category.subs.filter(s => s.id !== subId);
                  renderSubsList(category.subs);
              }

              // Ø«Ù… Ø¥Ø±Ø³Ø§Ù„ Ù„Ù„Ù€ API
              await CategoriesService.deleteSub(subId);
              console.log('âœ… ØªÙ… Ø­Ø°Ù Ø§Ù„Ù‚Ø³Ù… Ø§Ù„ÙØ±Ø¹ÙŠ Ø¨Ù†Ø¬Ø§Ø­');
          } catch (error) {
              console.error(error);
              // Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø¹Ù†Ø¯ Ø§Ù„Ø®Ø·Ø£ ÙÙ‚Ø·
              await loadCategoryData(editingCategoryId);
              alert('âŒ Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ù‚Ø³Ù… Ø§Ù„ÙØ±Ø¹ÙŠ: ' + error.message);
          }
      }

      function closeCategoryModal() {
          document.getElementById('category-modal').classList.remove('active');
          editingCategoryId = null;
      }

      async function saveCategory(e) {
          e.preventDefault();

          // ğŸ”’ Ù…Ù†Ø¹ Ø§Ù„Ø¶ØºØ· Ø§Ù„Ù…ØªÙƒØ±Ø±
          if (isSaving) {
              console.warn('â³ Ø¹Ù…Ù„ÙŠØ© Ø­ÙØ¸ Ø¬Ø§Ø±ÙŠØ©... ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±');
              return;
          }

          const idInput = document.getElementById('cat-id');
          const nameArInput = document.getElementById('cat-name-ar');
          const nameEnInput = document.getElementById('cat-name-en');
          const iconInput = document.getElementById('cat-icon');
          const submitBtn = document.querySelector('#category-form button[type="submit"]');

          const categoryData = {
              id: idInput.value.trim(),
              name_ar: nameArInput.value.trim(),
              name_en: nameEnInput.value.trim() || null,
              icon: iconInput.value.trim() || 'folder'
          };

          try {
              // ğŸ”’ ØªØ¹Ø·ÙŠÙ„ Ø§Ù„Ø²Ø± ÙˆØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø©
              isSaving = true;
              if (submitBtn) {
                  submitBtn.disabled = true;
                  submitBtn.innerHTML = '<i data-lucide="loader" style="width: 18px; height: 18px; animation: spin 1s linear infinite;"></i> Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸...';
                  lucide.createIcons();
              }

              // ğŸŒŸ ØªØ­Ø¯ÙŠØ« Ù…Ø­Ù„ÙŠ ÙÙˆØ±ÙŠ (ØªØ¬Ø±Ø¨Ø© Ø³Ø±ÙŠØ¹Ø©)
              if (editingCategoryId) {
                  // ØªØ­Ø¯ÙŠØ« Ù…Ø­Ù„ÙŠ Ù„Ù„ÙØ¦Ø© Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø©
                  updateLocalCategory(editingCategoryId, {
                      name_ar: categoryData.name_ar,
                      name_en: categoryData.name_en,
                      icon: categoryData.icon,
                      label: categoryData.name_ar
                  });

                  // Ø«Ù… Ø¥Ø±Ø³Ø§Ù„ Ù„Ù„Ù€ API
                  await CategoriesService.update(editingCategoryId, {
                      name_ar: categoryData.name_ar,
                      name_en: categoryData.name_en,
                      icon: categoryData.icon
                  });
                  console.log('âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙØ¦Ø© Ø¨Ù†Ø¬Ø§Ø­');
              } else {
                  // Ø¥Ø¶Ø§ÙØ© Ø§Ù„ÙØ¦Ø© Ù…Ø­Ù„ÙŠÙ‹Ø§ ÙÙˆØ±Ù‹Ø§
                  addCategoryLocally(categoryData);

                  // Ø«Ù… Ø¥Ø±Ø³Ø§Ù„ Ù„Ù„Ù€ API
                  const response = await CategoriesService.create(categoryData);
                  console.log('âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„ÙØ¦Ø© Ø¨Ù†Ø¬Ø§Ø­:', response);
              }

              closeCategoryModal();

              // ğŸŒŸ ØªØ­Ø¯ÙŠØ« Ø®ÙÙŠÙ Ø¨Ø¯ÙˆÙ† ØªØ­Ù…ÙŠÙ„ ÙƒØ§Ù…Ù„
              // (Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ© Ù…ÙˆØ¬ÙˆØ¯Ø© Ø¨Ø§Ù„ÙØ¹Ù„)
              setTimeout(() => lucide.createIcons(), 100);

          } catch (error) {
              console.error('âŒ Ø®Ø·Ø£:', error);
              // Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø³Ø§Ø¨Ù‚Ø© ÙÙŠ Ø­Ø§Ù„Ø© Ø§Ù„Ø®Ø·Ø£
              if (editingCategoryId) {
                  loadCategories(); // Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø¹Ù†Ø¯ Ø§Ù„Ø®Ø·Ø£ ÙÙ‚Ø·
              }
              alert('âŒ Ø­Ø¯Ø« Ø®Ø·Ø£: ' + error.message);
          } finally {
              // ğŸ”’ Ø¥Ø¹Ø§Ø¯Ø© ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø²Ø±
              isSaving = false;
              if (submitBtn) {
                  submitBtn.disabled = false;
                  submitBtn.innerHTML = 'Ø­ÙØ¸ Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ';
              }
          }
      }

      async function editCategory(catId) {
          openCategoryModal(catId);
      }

      async function deleteCategory(catId) {
          if (!confirm('âš ï¸ Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù‚Ø³Ù…ØŸ\n\nØ³ÙŠØªÙ… Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ø§Ù„ÙØ±Ø¹ÙŠØ© ÙˆØ§Ù„Ø£Ù…Ø§ÙƒÙ† Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ù‡.')) {
              return;
          }

          try {
              await CategoriesService.delete(catId);
              console.log('âœ… ØªÙ… Ø§Ù„Ø­Ø°Ù Ø¨Ù†Ø¬Ø§Ø­');
              await loadCategories();
          } catch (error) {
              console.error(error);
              alert('âŒ Ø­Ø¯Ø« Ø®Ø·Ø£: ' + error.message);
          }
      }

      init();
    </script>
  </body>
</html>
