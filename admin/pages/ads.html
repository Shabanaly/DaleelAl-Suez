<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>إدارة الإعلانات - دليل السويس</title>
    <script src="../services/auth.service.js"></script>
    <script>AuthService.checkAuth();</script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="../../js/config.js"></script>
    <link rel="stylesheet" href="../css/admin.css">
    
    <script src="../services/supabase.js"></script>
    <script src="../services/ads.service.js"></script>
    <script src="../components/sidebar.js"></script>
    <script src="../components/topbar.js"></script>
    <script src="../utils/drawer.js"></script>
</head>
<body>
    <div class="app-layout">
        <div id="sidebar-container"></div>
        <main class="main-content">
            <div id="topbar-container"></div>
            <div class="page-content">
                
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:24px;">
                    <h2 class="page-title">إدارة مساحات الإعلانات</h2>
                    <p style="color: var(--text-muted); font-size: 14px;">تحكم في ظهور إعلانات Google Adsense عبر الموقع</p>
                </div>

                <div id="ads-list" class="grid-2">
                    <!-- Ad slots will be rendered here -->
                    <div class="card">جاري تحميل المساحات...</div>
                </div>

            </div>
        </main>
    </div>

    <script>
        document.getElementById('sidebar-container').innerHTML = Sidebar.render('ads');
        document.getElementById('topbar-container').innerHTML = Topbar.render('الإعلانات');
        lucide.createIcons();

        async function init() {
            try {
                const slots = await AdsService.getAll();
                renderAds(slots);
            } catch (e) {
                console.error(e);
                document.getElementById('ads-list').innerHTML = `<div class="card" style="color:var(--danger)">خطأ في تحميل البيانات: ${e.message}</div>`;
            }
        }

        function renderAds(slots) {
            const container = document.getElementById('ads-list');
            if(!slots.length) {
                container.innerHTML = '<div class="card">لا يوجد مساحات إعلانية معرفة</div>';
                return;
            }

            container.innerHTML = slots.map(slot => `
                <div class="card" style="border-top: 3px solid ${slot.is_active ? 'var(--success)' : 'var(--border)'}">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                        <div>
                            <h3 style="font-size:16px; font-weight:800;">${slot.slot_label}</h3>
                            <code style="font-size:11px; opacity:0.6;">ID: ${slot.slot_id}</code>
                        </div>
                        <label class="switch">
                            <input type="checkbox" id="toggle-${slot.id}" ${slot.is_active ? 'checked' : ''} onchange="toggleStatus('${slot.id}')">
                            <span class="slider"></span>
                        </label>
                    </div>

                    <div class="form-group">
                        <label class="form-label">كود الإعلان (HTML/JS)</label>
                        <textarea id="code-${slot.id}" class="form-control" style="height:120px; font-family:monospace; font-size:12px; background:var(--bg-body);" 
                                  placeholder="انسخ كود Adsense هنا...">${slot.ad_code || ''}</textarea>
                    </div>

                    <div style="display:flex; justify-content:flex-end; gap:10px; margin-top:16px;">
                        <button class="btn btn-primary btn-sm" onclick="saveAd('${slot.id}')" id="btn-${slot.id}">
                            <i data-lucide="save"></i> حفظ الكود
                        </button>
                    </div>
                </div>
            `).join('');
            lucide.createIcons();
        }

        async function toggleStatus(id) {
            const is_active = document.getElementById(`toggle-${id}`).checked;
            try {
                await AdsService.update(id, { is_active });
                init(); // Refresh to update borders
            } catch (e) {
                alert('فشل تحديث الحالة: ' + e.message);
                document.getElementById(`toggle-${id}`).checked = !is_active;
            }
        }

        async function saveAd(id) {
            const ad_code = document.getElementById(`code-${id}`).value;
            const btn = document.getElementById(`btn-${id}`);
            const originalHTML = btn.innerHTML;

            btn.disabled = true;
            btn.innerHTML = '<i data-lucide="loader" class="spin"></i>';
            lucide.createIcons();

            try {
                await AdsService.update(id, { ad_code });
                btn.innerHTML = '<i data-lucide="check"></i> تم الحفظ';
                btn.style.background = 'var(--success)';
                setTimeout(() => {
                    btn.disabled = false;
                    btn.innerHTML = originalHTML;
                    btn.style.background = '';
                    lucide.createIcons();
                }, 2000);
            } catch (e) {
                alert('خطأ في الحفظ: ' + e.message);
                btn.disabled = false;
                btn.innerHTML = originalHTML;
                lucide.createIcons();
            }
        }

        init();
    </script>

    <style>
        /* Modern Switch Styles */
        .switch { position: relative; display: inline-block; width: 44px; height: 24px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: var(--border); transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--success); }
        input:focus + .slider { box-shadow: 0 0 1px var(--success); }
        input:checked + .slider:before { transform: translateX(20px); }
        
        .btn-sm { padding: 8px 16px; font-size: 13px; }
        .spin { animation: spin 1s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
    </style>
</body>
</html>
